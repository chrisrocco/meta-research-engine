<?php

use Models\Vertices\Paper;

/**
 * Created by PhpStorm.
 * User: chris
 * Date: 4/30/17
 * Time: 12:00 AM
 */
class PaperTest extends \Tests\BaseTestCase
{
    public static function setUpBeforeClass() {
        parent::setUpBeforeClass();
        \DB\DB::query('UPSERT {_key : "test"} INSERT {_key : "test", pmcID : 1234, title: "test"} UPDATE {} INTO @@papers',['@papers' => Paper::$collection]);
        \DB\DB::query('UPSERT {_key : "test"} INSERT {_key : "test", pmcID : 1234, title: "test"} UPDATE {} INTO @@users',['@users' => \Models\Vertices\User::$collection]);
        \DB\DB::query('LET asses = [{"_key":"352","_id":"assignments/352","_rev":"_U3LmDG6--H","encoding":{"branches":[[]],"constants":[{"data":{"value":"prior to the experiment, mice were provided food and water ad libitum for three days"},"question":"acclimationPeriod"},{"data":{"value":0},"question":"acclimationDuration"},{"data":{"value":70},"question":"ageAtStart"},{"data":{},"question":"ageAtWeight"},{"data":{"value":"The Jackson Labaratory"},"question":"facilityName"},{"data":{"value":"Bar Harbor, ME"},"question":"facilityCityState"},{"data":{"value":"United States"},"question":"facilityCountry"},{"data":{"value":"field.falseOption"},"question":"animalLocations"},{"data":{"value":"Not germ free"},"question":"pathogenFreeEnvironment"},{"data":{"value":"Other","disabled":true},"question":"cageType"},{"data":{"value":"","disabled":true},"question":"airCirculation"},{"data":{"value":"","disabled":true},"question":"beddingMaterial"},{"data":{"value":"","disabled":true},"question":"changeFrequency"},{"data":{"value":"","disabled":true},"question":"enrichmentType"},{"data":{"value":"field.trueOption"},"question":"lightingSchedule"},{"data":{"value":"","disabled":true},"question":"lightHours"},{"data":{"value":"","disabled":true},"question":"darkHours"},{"data":{"value":"","disabled":true},"question":"lightStartTime"},{"data":{"value":"","disabled":true},"question":"facilityHumidity"},{"data":{"value":"","disabled":true},"question":"constantTemperature"},{"data":{"value":"","disabled":true},"question":"temperatureRange"},{"data":{"value":"","disabled":true},"question":"dietType"},{"data":{"value":"LabDiet 5001"},"question":"dietID"},{"data":{"value":"Purina Mills"},"question":"dietVendor"},{"data":{"value":"Gray Summit, MO"},"question":"dietVendorCity"},{"data":{"value":"Ad libitum"},"question":"feedingFrequency"},{"data":{"value":"","disabled":true},"question":"percentEnergy"},{"data":{"value":"","disabled":true},"question":"percentFat"},{"data":{"value":"","disabled":true},"question":"percentCarbohydrates"},{"data":{"value":"","disabled":true},"question":"percentProtein"},{"data":{"value":"","disabled":true},"question":"exerciseType"},{"data":{"value":"","disabled":true},"question":"exerciseFreq"},{"data":{"value":"","disabled":true},"question":"forcedExcecise"},{"data":{"value":28},"question":"daysOnTreatment"},{"data":{"value":"The Jackson Laboratory"},"question":"vendorName"},{"data":{"value":"","disabled":true},"question":"miceVendorCity"},{"data":{"value":"","disabled":true},"question":"vendorCountry"},{"data":{"value":"Male","disabled":true},"question":"sex"},{"data":{"value":"C57BL/6J"},"question":"breed"},{"data":{"value":"","disabled":true},"question":"surgeryType"},{"data":{"value":"","disabled":true},"question":"routeOfAdministration"},{"data":{"value":"","disabled":true},"question":"compoundName"},{"data":{"value":"","disabled":true},"question":"compoundFrequency"},{"data":{"value":"","disabled":true},"question":"dosage"},{"data":{"value":"","disabled":true},"question":"geneticManipulationType"},{"data":{"value":"field.trueOption"},"question":"ethicalStatement"},{"data":{"value":2},"question":"micePerCage"},{"data":{"value":"","disabled":true},"question":"sampleSize"},{"data":{"value":"","disabled":true},"question":"whereReported"},{"data":{"value":"","disabled":true},"question":"averageFinalWeight"},{"data":{"value":"","disabled":true},"question":"errorOfMeasurmentValue"},{"data":{"value":"","disabled":true},"question":"errorOfMeasurmentType"}]},"date_created":"2017-02-27 08:37:03","status":"active","completion":"100"},{"_key":"782","_id":"assignments/782","_rev":"_U3LmDLK--Q","encoding":{"branches":[[]],"constants":[{"data":{"value":""},"question":"acclimationPeriod"},{"data":{"value":""},"question":"acclimationDuration"},{"data":{"value":10},"question":"ageAtStart"},{"data":{"value":10},"question":"ageAtWeight"},{"data":{"value":"The Jackson Laboratory"},"question":"facilityName"},{"data":{"value":"Bar Harbor,ME"},"question":"facilityCityState"},{"data":{"value":"United States"},"question":"facilityCountry"},{"data":{"value":"field.falseOption"},"question":"animalLocations"},{"data":{"value":"Completely germ-free"},"question":"pathogenFreeEnvironment"},{"data":{"value":"Open cages"},"question":"cageType"},{"data":{"value":""},"question":"airCirculation"},{"data":{"value":""},"question":"beddingMaterial"},{"data":{"value":""},"question":"changeFrequency"},{"data":{"value":""},"question":"enrichmentType"},{"data":{"value":""},"question":"lightingSchedule"},{"data":{"value":""},"question":"lightHours"},{"data":{"value":""},"question":"darkHours"},{"data":{"value":""},"question":"lightStartTime"},{"data":{"value":""},"question":"facilityHumidity"},{"data":{"value":""},"question":"constantTemperature"},{"data":{"value":""},"question":"temperatureRange"},{"data":{"value":""},"question":"dietType"},{"data":{"value":"5001"},"question":"dietID"},{"data":{"value":"LabDiet"},"question":"dietVendor"},{"data":{"value":"Purina Mills,Gray Summit,MO"},"question":"dietVendorCity"},{"data":{"value":"Ad libitum"},"question":"feedingFrequency"},{"data":{"value":""},"question":"percentEnergy"},{"data":{"value":""},"question":"percentFat"},{"data":{"value":""},"question":"percentCarbohydrates"},{"data":{"value":""},"question":"percentProtein"},{"data":{"value":""},"question":"exerciseType"},{"data":{"value":""},"question":"exerciseFreq"},{"data":{"value":""},"question":"forcedExcecise"},{"data":{"value":""},"question":"daysOnTreatment"},{"data":{"value":""},"question":"vendorName"},{"data":{"value":""},"question":"miceVendorCity"},{"data":{"value":""},"question":"vendorCountry"},{"data":{"value":""},"question":"sex"},{"data":{"value":""},"question":"breed"},{"data":{"value":""},"question":"surgeryType"},{"data":{"value":""},"question":"routeOfAdministration"},{"data":{"value":""},"question":"compoundName"},{"data":{"value":""},"question":"compoundFrequency"},{"data":{"value":""},"question":"dosage"},{"data":{"value":""},"question":"geneticManipulationType"},{"data":{"value":""},"question":"ethicalStatement"},{"data":{"value":""},"question":"micePerCage"},{"data":{"value":""},"question":"sampleSize"},{"data":{"value":""},"question":"whereReported"},{"data":{"value":""},"question":"averageFinalWeight"},{"data":{"value":""},"question":"errorOfMeasurmentValue"},{"data":{"value":""},"question":"errorOfMeasurmentType"}]},"date_created":"2017-03-06 10:43:37","status":"active","completion":"11"},{"_key":"281","_id":"assignments/281","_rev":"_U3LmDL---O","encoding":{"branches":[[]],"constants":[{"data":{"value":"After three days of cage acclimation, unanesthetized mice (4 per exposure) were irradiated (IR; JL Shepherd Mark I, 137Cs gamma ray source, San Gabriel, CA) with 1, 10, or 100â€‰cGy at 0.96, 0.96, or 88â€‰cGy/min (Â±10%), respectively, or were sham-irradiated (0â€‰cGy-controls)."},"question":"acclimationPeriod"},{"data":{"value":4},"question":"acclimationDuration"},{"data":{"value":3},"question":"ageAtStart"},{"data":{"value":5},"question":"ageAtWeight"},{"data":{"value":"","disabled":true},"question":"facilityName"},{"data":{"value":"Moffett fields, California and Irvine, California"},"question":"facilityCityState"},{"data":{"value":"United States"},"question":"facilityCountry"},{"data":{"value":"field.trueOption"},"question":"animalLocations"},{"data":{"value":"Completely germ-free"},"question":"pathogenFreeEnvironment"},{"data":{"value":"Open cages"},"question":"cageType"},{"data":{"value":"Open cages"},"question":"airCirculation"},{"data":{"value":"","disabled":true},"question":"beddingMaterial"},{"data":{"value":"","disabled":true},"question":"changeFrequency"},{"data":{"value":"","disabled":true},"question":"enrichmentType"},{"data":{"value":"field.falseOption"},"question":"lightingSchedule"},{"data":{"value":2},"question":"lightHours"},{"data":{"value":5},"question":"darkHours"},{"data":{"value":10},"question":"lightStartTime"},{"data":{"upperValue":75,"value":"","lowerValue":38},"question":"facilityHumidity"},{"data":{"value":"field.trueOption"},"question":"constantTemperature"},{"data":{"upperValue":46,"value":"","lowerValue":0},"question":"temperatureRange"},{"data":{"value":"Food and water ad lubitium"},"question":"dietType"},{"data":{"value":"C57BL/6J"},"question":"dietID"},{"data":{"value":"NASA"},"question":"dietVendor"},{"data":{"value":"Moffet Field, CA and Irvine, CA"},"question":"dietVendorCity"},{"data":{"value":"Ad libitum"},"question":"feedingFrequency"},{"data":{"value":"field.falseOption"},"question":"percentEnergy"},{"data":{"value":25},"question":"percentFat"},{"data":{"value":45},"question":"percentCarbohydrates"},{"data":{"value":30},"question":"percentProtein"},{"data":{"value":"","disabled":true},"question":"exerciseType"},{"data":{"value":"Weekly"},"question":"exerciseFreq"},{"data":{"value":"field.falseOption"},"question":"forcedExcecise"},{"data":{},"question":"daysOnTreatment"},{"data":{"value":"NASA"},"question":"vendorName"},{"data":{"value":"Moffett Field, CA and Irvine, CA"},"question":"miceVendorCity"},{"data":{"value":"United States"},"question":"vendorCountry"},{"data":{"value":"Male"},"question":"sex"},{"data":{"value":"C57BL/6J"},"question":"breed"},{"data":{"value":"Gastric bypass"},"question":"surgeryType"},{"data":{"value":"Food"},"question":"routeOfAdministration"},{"data":{"value":"Sucrose"},"question":"compoundName"},{"data":{"value":"Weekly"},"question":"compoundFrequency"},{"data":{"value":"200IU"},"question":"dosage"},{"data":{"value":"They were given osteoporosis"},"question":"geneticManipulationType"},{"data":{"value":"field.falseOption"},"question":"ethicalStatement"},{"data":{"value":2},"question":"micePerCage"},{"data":{"value":5},"question":"sampleSize"},{"data":{"value":"Text, with numbers reported"},"question":"whereReported"},{"data":{"value":30},"question":"averageFinalWeight"},{"data":{},"question":"errorOfMeasurmentValue"},{"data":{"value":"Standard Deviation (S.D. or s.d.)"},"question":"errorOfMeasurmentType"}]},"date_created":"2017-02-24 22:31:42","status":"active","completion":"100"},{"_key":"531","_id":"assignments/531","_rev":"_U3LmDKi--I","encoding":{"branches":[[]],"constants":[{"data":{"value":"Mice were provided food (LabDiet 5001, Purina Mills, Gray Summit, MO) and water ad libitum."},"question":"acclimationPeriod"},{"data":{"value":16},"question":"acclimationDuration"},{"data":{"value":10},"question":"ageAtStart"},{"data":{"value":27},"question":"ageAtWeight"},{"data":{"value":"The Jackson Laboratory"},"question":"facilityName"},{"data":{"value":"Bar Harbor, ME"},"question":"facilityCityState"},{"data":{"value":"USA"},"question":"facilityCountry"},{"data":{"value":"field.falseOption"},"question":"animalLocations"},{"data":{"value":"","disabled":true},"question":"pathogenFreeEnvironment"},{"data":{"value":"","disabled":true},"question":"cageType"},{"data":{"value":"","disabled":true},"question":"airCirculation"},{"data":{"value":"","disabled":true},"question":"beddingMaterial"},{"data":{"value":"","disabled":true},"question":"changeFrequency"},{"data":{"value":"","disabled":true},"question":"enrichmentType"},{"data":{"value":"","disabled":true},"question":"lightingSchedule"},{"data":{"value":"","disabled":true},"question":"lightHours"},{"data":{"value":"","disabled":true},"question":"darkHours"},{"data":{"value":"","disabled":true},"question":"lightStartTime"},{"data":{"value":"","disabled":true},"question":"facilityHumidity"},{"data":{"value":"","disabled":true},"question":"constantTemperature"},{"data":{"value":"","disabled":true},"question":"temperatureRange"},{"data":{"value":"Lab diet"},"question":"dietType"},{"data":{"value":"5001"},"question":"dietID"},{"data":{"value":"Purina Mills, Gray Summit, MO"},"question":"dietVendor"},{"data":{"value":"Gray Summit, MO"},"question":"dietVendorCity"},{"data":{"value":"","disabled":true},"question":"feedingFrequency"},{"data":{"value":"","disabled":true},"question":"percentEnergy"},{"data":{"value":"","disabled":true},"question":"percentFat"},{"data":{"value":"","disabled":true},"question":"percentCarbohydrates"},{"data":{"value":"","disabled":true},"question":"percentProtein"},{"data":{"value":"","disabled":true},"question":"exerciseType"},{"data":{"value":"","disabled":true},"question":"exerciseFreq"},{"data":{"value":"","disabled":true},"question":"forcedExcecise"},{"data":{"value":"","disabled":true},"question":"daysOnTreatment"},{"data":{"value":"","disabled":true},"question":"vendorName"},{"data":{"value":"","disabled":true},"question":"miceVendorCity"},{"data":{"value":"","disabled":true},"question":"vendorCountry"},{"data":{"value":"Male"},"question":"sex"},{"data":{"value":"C57BL/6J"},"question":"breed"},{"data":{"value":"Tissues were harvested on the day of IR (basal) or 1 or 4 months later (n = 8/group), with cell culture being performed at the latter two endpoints."},"question":"surgeryType"},{"data":{"value":"Topically (on the bodys surface"},"question":"routeOfAdministration"},{"data":{"value":"(IR; JL Shepherd Mark I, 137Cs"},"question":"compoundName"},{"data":{"value":"","disabled":true},"question":"compoundFrequency"},{"data":{"value":"","disabled":true},"question":"dosage"},{"data":{"value":"","disabled":true},"question":"geneticManipulationType"},{"data":{"value":"field.trueOption"},"question":"ethicalStatement"},{"data":{"value":2},"question":"micePerCage"},{"data":{"value":8},"question":"sampleSize"},{"data":{"value":"Text, with numbers reported"},"question":"whereReported"},{"data":{"value":30},"question":"averageFinalWeight"},{"data":{"value":10},"question":"errorOfMeasurmentValue"},{"data":{"value":"","disabled":true},"question":"errorOfMeasurmentType"}]},"date_created":"2017-03-06 08:17:29","status":"active","completion":"100"},{"_key":"363","_id":"assignments/363","_rev":"_U3LmDLK--O","encoding":{"branches":[[]],"constants":[{"data":{"value":"Mice were irradiated and tissues were harvested on the day of irradiation."},"question":"acclimationPeriod"},{"data":{"value":12},"question":"acclimationDuration"},{"data":{"value":70,"disabled":false},"question":"ageAtStart"},{"data":{"value":189},"question":"ageAtWeight"},{"data":{"value":"The Jackson Laboratory"},"question":"facilityName"},{"data":{"value":"Bar Harbor, ME"},"question":"facilityCityState"},{"data":{"value":"USA"},"question":"facilityCountry"},{"data":{"value":"field.falseOption"},"question":"animalLocations"},{"data":{"value":""},"question":"pathogenFreeEnvironment"},{"data":{"value":""},"question":"cageType"},{"data":{"value":""},"question":"airCirculation"},{"data":{"value":""},"question":"beddingMaterial"},{"data":{"value":""},"question":"changeFrequency"},{"data":{"value":""},"question":"enrichmentType"},{"data":{"value":""},"question":"lightingSchedule"},{"data":{"value":""},"question":"lightHours"},{"data":{"value":""},"question":"darkHours"},{"data":{"value":""},"question":"lightStartTime"},{"data":{"value":""},"question":"facilityHumidity"},{"data":{"value":""},"question":"constantTemperature"},{"data":{"value":""},"question":"temperatureRange"},{"data":{"value":"LabDiet 5001, Purina Mills, Gray Summit, MO"},"question":"dietType"},{"data":{"value":"LabDiet 5001"},"question":"dietID"},{"data":{"value":"Purina Mills"},"question":"dietVendor"},{"data":{"value":"Gray Summit, MO"},"question":"dietVendorCity"},{"data":{"value":"Ad libitum"},"question":"feedingFrequency"},{"data":{"value":""},"question":"percentEnergy"},{"data":{"value":""},"question":"percentFat"},{"data":{"value":""},"question":"percentCarbohydrates"},{"data":{"value":""},"question":"percentProtein"},{"data":{"value":""},"question":"exerciseType"},{"data":{"value":""},"question":"exerciseFreq"},{"data":{"value":"field.falseOption"},"question":"forcedExcecise"},{"data":{"value":""},"question":"daysOnTreatment"},{"data":{"value":"The Jackson Laboratory"},"question":"vendorName"},{"data":{"value":"Bar Harbor, ME"},"question":"miceVendorCity"},{"data":{"value":"USA"},"question":"vendorCountry"},{"data":{"value":"Male"},"question":"sex"},{"data":{"value":""},"question":"breed"},{"data":{"value":""},"question":"surgeryType"},{"data":{"value":""},"question":"routeOfAdministration"},{"data":{"value":""},"question":"compoundName"},{"data":{"value":""},"question":"compoundFrequency"},{"data":{"value":""},"question":"dosage"},{"data":{"value":""},"question":"geneticManipulationType"},{"data":{"value":""},"question":"ethicalStatement"},{"data":{"value":4},"question":"micePerCage"},{"data":{"value":4},"question":"sampleSize"},{"data":{"value":"In a figure"},"question":"whereReported"},{"data":{},"question":"averageFinalWeight"},{"data":{"value":"","disabled":false},"question":"errorOfMeasurmentValue"},{"data":{"value":""},"question":"errorOfMeasurmentType"}]},"date_created":"2017-02-28 08:51:35","status":"active","completion":"100"}] FOR a IN asses UPSERT {_key: a._key} INSERT MERGE(a, {_from : "papers/test", _to: CONCAT("users/", a._key)}) UPDATE {}  INTO @@assignments',['@assignments' => \Models\Edges\Assignment::$collection]);
    }

    public function testCreate(){
        $paper_data = [
            'title' =>  'Test Paper',
            'pmcID' =>  '12345',
            'masterEncoding' => []
        ];
        $paper = Paper::create($paper_data);

        $from_DB = Paper::retrieve( $paper->key() );

        self::assertInstanceOf(Paper::class, $from_DB);
        return $from_DB;
    }

    /**
     * @depends testCreate
     * @var paper Paper
     */
    public function testMerge ($paper) {
        $assignmentKeys = ["352", "782", "281", "531", "363"];
        $changedEncoding = json_decode('{"branches":[[]],"constants":[{"data":{"value":"Mice were NOT1234 irradiated and tissues were harvested on the day of irradiation."},"question":"acclimationPeriod"},{"data":{"value":12},"question":"acclimationDuration"},{"data":{"value":70,"disabled":false},"question":"ageAtStart"},{"data":{"value":189},"question":"ageAtWeight"},{"data":{"value":"The Jackson Laboratory"},"question":"facilityName"},{"data":{"value":"Bar Harbor, ME"},"question":"facilityCityState"},{"data":{"value":"USA"},"question":"facilityCountry"},{"data":{"value":"field.falseOption"},"question":"animalLocations"},{"data":{"value":""},"question":"pathogenFreeEnvironment"},{"data":{"value":""},"question":"cageType"},{"data":{"value":""},"question":"airCirculation"},{"data":{"value":""},"question":"beddingMaterial"},{"data":{"value":""},"question":"changeFrequency"},{"data":{"value":""},"question":"enrichmentType"},{"data":{"value":""},"question":"lightingSchedule"},{"data":{"value":""},"question":"lightHours"},{"data":{"value":""},"question":"darkHours"},{"data":{"value":""},"question":"lightStartTime"},{"data":{"value":""},"question":"facilityHumidity"},{"data":{"value":""},"question":"constantTemperature"},{"data":{"value":""},"question":"temperatureRange"},{"data":{"value":"LabDiet 5001, Purina Mills, Gray Summit, MO"},"question":"dietType"},{"data":{"value":"LabDiet 5001"},"question":"dietID"},{"data":{"value":"Purina Mills"},"question":"dietVendor"},{"data":{"value":"Gray Summit, MO"},"question":"dietVendorCity"},{"data":{"value":"Ad libitum"},"question":"feedingFrequency"},{"data":{"value":""},"question":"percentEnergy"},{"data":{"value":""},"question":"percentFat"},{"data":{"value":""},"question":"percentCarbohydrates"},{"data":{"value":""},"question":"percentProtein"},{"data":{"value":""},"question":"exerciseType"},{"data":{"value":""},"question":"exerciseFreq"},{"data":{"value":"field.falseOption"},"question":"forcedExcecise"},{"data":{"value":""},"question":"daysOnTreatment"},{"data":{"value":"The Jackson Laboratory"},"question":"vendorName"},{"data":{"value":"Bar Harbor, ME"},"question":"miceVendorCity"},{"data":{"value":"USA"},"question":"vendorCountry"},{"data":{"value":"Male"},"question":"sex"},{"data":{"value":""},"question":"breed"},{"data":{"value":""},"question":"surgeryType"},{"data":{"value":""},"question":"routeOfAdministration"},{"data":{"value":""},"question":"compoundName"},{"data":{"value":""},"question":"compoundFrequency"},{"data":{"value":""},"question":"dosage"},{"data":{"value":""},"question":"geneticManipulationType"},{"data":{"value":""},"question":"ethicalStatement"},{"data":{"value":4},"question":"micePerCage"},{"data":{"value":4},"question":"sampleSize"},{"data":{"value":"In a figure"},"question":"whereReported"},{"data":{},"question":"averageFinalWeight"},{"data":{"value":"","disabled":false},"question":"errorOfMeasurmentValue"},{"data":{"value":""},"question":"errorOfMeasurmentType"}]}', true);
        foreach ($assignmentKeys as $key) {
            $assignment = \Models\Edges\Assignment::retrieve($key);
            $changed = self::recordMergeChange($paper, $assignment, $key);
            self::assertTrue($changed);
        }
        $lastKey = end($assignmentKeys);
        $lastAssignment = \Models\Edges\Assignment::retrieve($lastKey);
        $shouldntChange = self::recordMergeChange($paper, $lastAssignment, $lastKey);
        self::assertFalse($shouldntChange);

        $ogEncoding = $lastAssignment->get('encoding');
        $lastAssignment->update('encoding', $changedEncoding);
        $shouldChange = self::recordMergeChange($paper, $lastAssignment, $lastKey);
        $lastAssignment->update('encoding', $ogEncoding);
        self::assertTrue($shouldChange);

        $numUsers = count ($paper->get('masterEncoding')[0][\MasterEncoding\MasterEncoding::RECORD_RESPONSES]);
        self::assertEquals(5, $numUsers);

    }

    /**
     * @group ignore
     * @param $paper Paper
     * @param $assignment \Models\Edges\Assignment
     */
    private static function recordMergeChange ($paper, $assignment, $key) {
//        echo "\nMerging user ".$key;
        $oldMasterEncoding = $paper->get('masterEncoding');
        $paper->merge($assignment);
        $hasChanged = $paper->get('masterEncoding') != $oldMasterEncoding;
//        echo $hasChanged ? " - with change" : " - without change";
        return $hasChanged;
    }


}